<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本片段选择器</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 内联样式，确保基本样式始终可用 */
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .group {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .group-header {
            background-color: #4a89dc;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-header:hover {
            background-color: #3b7dd8;
        }
        
        .group-content {
            display: none;
            padding: 0;
        }
        
        .group.expanded .group-content {
            display: block;
        }
        
        .snippet-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .snippet-item:last-child {
            border-bottom: none;
        }
        
        .snippet-item:hover {
            background-color: #f0f7ff;
        }
        
        .snippet-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .snippet-content {
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        
        .hint {
            text-align: center;
            color: #999;
            margin-top: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="text" id="searchBox" class="search-box" placeholder="搜索片段..." autofocus>
        
        <div id="snippetsContainer">
            <!-- 片段分组将在这里动态生成 -->
            <div class="hint">加载中，请稍候...</div>
        </div>
        
        <div class="hint">
            提示: 双击片段复制到剪贴板，按ESC关闭窗口
        </div>
    </div>

    <script>
        // 全局变量
        let snippetsData = {};
        let settings = {};
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从AHK获取数据
            requestDataFromAHK();
            
            // 设置搜索框事件
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', filterSnippets);
            
            // 设置键盘事件
            document.addEventListener('keydown', function(e) {
                // ESC键关闭窗口
                if (e.key === 'Escape') {
                    window.chrome.webview.postMessage({
                        action: 'close'
                    });
                }
            });
        });
        
        // 从AHK请求数据
        function requestDataFromAHK() {
            window.chrome.webview.postMessage({
                action: 'getData'
            });
        }
        
        // 接收来自AHK的数据
        window.receiveData = function(data) {
            snippetsData = data.snippets || {};
            settings = data.settings || {};
            
            // 渲染片段
            renderSnippets();
        };
        
        // 渲染片段列表
        function renderSnippets() {
            const container = document.getElementById('snippetsContainer');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let hasVisibleSnippets = false;
            
            // 遍历分组
            for (const groupName in snippetsData) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';
                groupDiv.dataset.group = groupName;
                
                // 创建分组标题
                const headerDiv = document.createElement('div');
                headerDiv.className = 'group-header';
                headerDiv.textContent = groupName;
                headerDiv.addEventListener('click', toggleGroup);
                
                // 创建分组内容容器
                const contentDiv = document.createElement('div');
                contentDiv.className = 'group-content';
                
                // 获取分组内容
                const group = snippetsData[groupName];
                let hasVisibleSnippet = false;
                
                // 遍历分组内的片段
                for (const snippetName in group) {
                    const snippetContent = group[snippetName];
                    
                    // 如果有搜索词，根据搜索词筛选
                    if (searchTerm && !snippetName.toLowerCase().includes(searchTerm) && 
                        !snippetContent.toLowerCase().includes(searchTerm)) {
                        continue;
                    }
                    
                    hasVisibleSnippet = true;
                    hasVisibleSnippets = true;
                    
                    // 创建片段项
                    const snippetDiv = document.createElement('div');
                    snippetDiv.className = 'snippet-item';
                    snippetDiv.dataset.name = snippetName;
                    snippetDiv.dataset.content = snippetContent;
                    snippetDiv.addEventListener('dblclick', copySnippet);
                    
                    // 创建片段名称
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'snippet-name';
                    nameDiv.textContent = snippetName;
                    
                    // 创建片段内容预览
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'snippet-content';
                    previewDiv.textContent = snippetContent.substring(0, 100) + 
                                            (snippetContent.length > 100 ? '...' : '');
                    
                    // 组装片段项
                    snippetDiv.appendChild(nameDiv);
                    snippetDiv.appendChild(previewDiv);
                    contentDiv.appendChild(snippetDiv);
                }
                
                // 如果分组中有可见片段才添加到容器
                if (hasVisibleSnippet) {
                    groupDiv.appendChild(headerDiv);
                    groupDiv.appendChild(contentDiv);
                    container.appendChild(groupDiv);
                    
                    // 如果有搜索词，默认展开分组
                    if (searchTerm) {
                        groupDiv.classList.add('expanded');
                    }
                }
            }
            
            // 如果没有匹配的片段
            if (!hasVisibleSnippets) {
                const noResults = document.createElement('div');
                noResults.className = 'hint';
                noResults.textContent = searchTerm ? 
                    `没有找到匹配 "${searchTerm}" 的片段` : 
                    '没有可用的片段，请在管理面板中添加';
                    
                container.appendChild(noResults);
            }
        }
        
        // 切换分组展开/折叠
        function toggleGroup(e) {
            const groupDiv = e.currentTarget.parentNode;
            groupDiv.classList.toggle('expanded');
        }
        
        // 根据搜索词过滤片段
        function filterSnippets() {
            renderSnippets();
        }
        
        // 复制片段到剪贴板
        function copySnippet(e) {
            const snippetDiv = e.currentTarget;
            const content = snippetDiv.dataset.content;
            
            // 发送消息到AHK复制内容
            window.chrome.webview.postMessage({
                action: 'copySnippet',
                content: content,
                autoHide: settings.autoHide || false
            });
            
            // 显示复制成功提示
            const originalBackground = snippetDiv.style.backgroundColor;
            snippetDiv.style.backgroundColor = '#d4edda';
            
            setTimeout(() => {
                snippetDiv.style.backgroundColor = originalBackground;
            }, 500);
        }
    </script>
</body>
</html> 